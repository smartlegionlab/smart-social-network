<script>
document.addEventListener('DOMContentLoaded', function() {
    const messagesContent = window.messagesContent || {};

    const chatMessages = $('.chat-messages');
    chatMessages.scrollTop(chatMessages[0].scrollHeight);

    let chatSocket;
    const chatId = '{{ chat.id }}';
    const userId = '{{ request.user.id }}';
    const messagesContainer = document.querySelector('.chat-messages');
    const messageForm = document.querySelector('#message-form');
    const messageInput = document.querySelector('#messageContent');
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.className = 'text-muted small mb-2';
    typingIndicator.style.display = 'none';
    messagesContainer.parentNode.insertBefore(typingIndicator, messagesContainer);

    function connectWebSocket() {
        chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/chat/' + chatId + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            switch(data.type) {
                case 'chat_message':
                    handleNewMessage(data);
                    break;
                case 'edit_message':
                    handleEditMessage(data);
                    break;
                case 'delete_message':
                    handleDeleteMessage(data);
                    break;
                case 'typing':
                    handleTyping(data);
                    break;
                case 'error':
                    console.error('WebSocket error:', data.error);
                    break;
            }
        };

        chatSocket.onclose = function(e) {
            console.log('WebSocket closed, reconnecting...');
            setTimeout(connectWebSocket, 5000);
        };

        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
    }

    function handleNewMessage(data) {
        const isCurrentUser = data.sender_id == userId;
        const onlineStatus = data.is_online ? 'bg-success' : 'bg-danger';

        messagesContent[data.message_id] = data.content;

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const messageTime = new Date(timestamp);
            const seconds = Math.floor((now - messageTime) / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (seconds < 60) return "just now";
            if (minutes < 60) return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
            if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;
            return `${days} day${days === 1 ? '' : 's'} ago`;
        }

        const timeAgo = formatTimeAgo(data.timestamp);

        const messageHtml = `
            <div class="mb-3 ${isCurrentUser ? 'text-end' : ''}" id="message-${data.message_id}">
                <div class="d-flex ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'} align-items-start">
                    ${!isCurrentUser ? `
                    <div class="position-relative me-2 img-block">
                        <img src="${data.sender_avatar}"
                             class="rounded-circle object-fit-cover w-100 h-100"
                             alt="${data.sender_name}">
                        <span class="position-absolute top-0 start-100 translate-middle p-1 border-2 border-white rounded-circle ${onlineStatus}"
                              style="transform: translate(-50%, -50%) scale(0.8); box-shadow: 0 0 3px rgba(0,0,0,0.2);"></span>
                    </div>
                    ` : ''}

                    <div class="position-relative message-container" data-sender-name="${data.sender_name}">
                        <div class="p-3 rounded ${isCurrentUser ? 'bg-primary text-white' : 'bg-light'}">
                            <span class="message-text">${data.content}</span>

                            ${isCurrentUser ? `
                            <div class="message-actions position-absolute end-0 top-0 mt-1 me-1">
                                <button class="btn btn-sm btn-link text-warning edit-message-btn"
                                        data-message-id="${data.message_id}"
                                        title="Edit message">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-link text-danger delete-message-btn"
                                        data-message-id="${data.message_id}"
                                        title="Delete message">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            ` : ''}
                        </div>
                        <small class="text-muted">
                            ${data.sender_name}, ${timeAgo}
                        </small>
                    </div>

                    ${isCurrentUser ? `
                    <div class="position-relative ms-2 img-block">
                        <img src="${data.sender_avatar}"
                             class="rounded-circle object-fit-cover w-100 h-100"
                             alt="${data.sender_name}">
                        <span class="position-absolute top-0 start-100 translate-middle p-1 border-2 border-white rounded-circle bg-success"
                              style="transform: translate(-50%, -50%) scale(0.8); box-shadow: 0 0 3px rgba(0,0,0,0.2);"></span>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;

        messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

function handleEditMessage(data) {
    // console.log('Edit message data:', data);

    const messageElements = document.querySelectorAll(`[id^="message-"]`);
    let messageElement = null;

    for (let el of messageElements) {
        if (el.id === `message-${data.message_id}`) {
            messageElement = el;
            break;
        }
    }

    if (messageElement) {
        // console.log('Found message element:', messageElement);

        let textContainer = messageElement.querySelector('.message-text');
        if (!textContainer) {
            const messageContainer = messageElement.querySelector('.message-container');
            if (messageContainer) {
                textContainer = messageContainer.querySelector('div > span:first-child');
            }
        }

        if (textContainer) {
            textContainer.textContent = data.content;
            messagesContent[data.message_id] = data.content;
            // console.log('Text updated successfully');
        } else {
            console.error('Text container not found in message element');
            // console.log('Message element HTML:', messageElement.innerHTML);
        }

        const timestampElement = messageElement.querySelector('small');
        if (timestampElement) {
            const senderName = messageElement.querySelector('.message-container')?.dataset?.senderName ||
                             messageElement.dataset.senderName ||
                             'Unknown';
            timestampElement.innerHTML = `
                ${senderName}, ${formatTimeAgo(data.timestamp)}
                <span class="text-muted small">(edited ${formatTimeAgo(data.edited_at)})</span>
            `;
            // console.log('Timestamp updated successfully');
        }
    } else {
        console.error(`Message element not found for ID: ${data.message_id}`);
    }
}

    function formatTimeAgo(timestamp) {
        const now = new Date();
        const messageTime = new Date(timestamp);
        const seconds = Math.floor((now - messageTime) / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (seconds < 60) return "just now";
        if (minutes < 60) return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
        if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;
        return `${days} day${days === 1 ? '' : 's'} ago`;
    }

    function handleDeleteMessage(data) {
        const messageElement = document.querySelector(`#message-${data.message_id}`);
        if (messageElement) {
            messageElement.remove();
        }
    }

    function handleTyping(data) {
        const typingIndicator = document.getElementById(`typing-indicator-${data.user_id}`);
        if (typingIndicator) {
            typingIndicator.textContent = data.is_typing ? `${data.username} is typing...` : '';
            typingIndicator.style.display = data.is_typing ? 'inline' : 'none';
        }
    }

    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (content && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                type: 'chat_message',
                content: content
            }));
            messageInput.value = '';
        }
    });

    let typingTimeout;
    messageInput.addEventListener('input', function() {
        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                type: 'typing',
                is_typing: true,
                user_id: userId,
                username: '{{ request.user.username }}'
            }));

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                chatSocket.send(JSON.stringify({
                    type: 'typing',
                    is_typing: false,
                    user_id: userId
                }));
            }, 2000);
        }
    });

    $(document).on('click', '.edit-message-btn', function() {
    const messageId = $(this).data('message-id');
    const messageContent = messagesContent[messageId] || $(this).data('content');

    if (messageContent) {
        $('#edit-message-id').val(messageId);
        $('#edit-message-content').val(messageContent);
        $('#editMessageModal').modal('show');
    } else {
        console.error('Message content not found for ID:', messageId);
        const messageElement = document.querySelector(`#message-${messageId}`);
        if (messageElement) {
            const text = messageElement.querySelector('.message-text')?.textContent;
            if (text) {
                $('#edit-message-id').val(messageId);
                $('#edit-message-content').val(text);
                $('#editMessageModal').modal('show');
                messagesContent[messageId] = text;
            }
        }
    }
});

    $('#edit-message-form').on('submit', function(e) {
        e.preventDefault();
        const messageId = $('#edit-message-id').val();
        const content = $('#edit-message-content').val().trim();
        if (content && messageId && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                type: 'edit_message',
                message_id: messageId,
                content: content
            }));
            $('#editMessageModal').modal('hide');
        }
    });

    $(document).on('click', '.delete-message-btn', function() {
        const messageId = $(this).data('message-id');
        if (confirm('Are you sure you want to delete this message?')) {
            if (chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    type: 'delete_message',
                    message_id: messageId
                }));
            }
        }
    });

    $('.emoji-option').click(function(e) {
        e.preventDefault();
        e.stopPropagation();
        const emoji = $(this).data('emoji');
        const textarea = $('#messageContent');
        const startPos = textarea[0].selectionStart;
        const endPos = textarea[0].selectionEnd;
        const currentText = textarea.val();
        textarea.val(currentText.substring(0, startPos) + emoji + currentText.substring(endPos));
        textarea.focus();
        textarea[0].setSelectionRange(startPos + emoji.length, startPos + emoji.length);
    });

    $('#clear-message').click(function() {
        $('#messageContent').val('').focus();
    });

    $(document).on('click', '.edit-emoji-option', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const emoji = $(this).data('emoji');
        const textarea = $('#edit-message-content');
        const startPos = textarea[0].selectionStart;
        const endPos = textarea[0].selectionEnd;
        const currentText = textarea.val();
        textarea.val(currentText.substring(0, startPos) + emoji + currentText.substring(endPos));
        textarea.focus();
        textarea[0].setSelectionRange(startPos + emoji.length, startPos + emoji.length);
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('#emojiDropdownContainer')) {
            bootstrap.Dropdown.getInstance(document.getElementById('emojiDropdownBtn'))?.hide();
        }
        if (!e.target.closest('#editEmojiDropdownContainer')) {
            bootstrap.Dropdown.getInstance(document.getElementById('editEmojiDropdownBtn'))?.hide();
        }
    });

    connectWebSocket();
});

$(document).on('click', '.load-more-messages', function(e) {
    e.preventDefault();
    let $btn = $(this);
    let url = $btn.attr('href');
    let $messagesContainer = $('.chat-messages');
    let scrollHeightBefore = $messagesContainer[0].scrollHeight;

    $.get(url, function(data) {
        let $newContent = $(data).find('.chat-messages').children();
        $btn.closest('.text-center').remove();

        $messagesContainer.prepend($newContent);

        $newContent.each(function() {
            const messageId = this.id.replace('message-', '');
            const content = $(this).find('.message-text').text();
            if (messageId && content) {
                messagesContent[messageId] = content;
            }
        });

        let scrollHeightAfter = $messagesContainer[0].scrollHeight;
        $messagesContainer.scrollTop(scrollHeightAfter - scrollHeightBefore);
    });
});

</script>