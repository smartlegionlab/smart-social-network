{% extends 'base.html' %}
{% load user_filters %}


{% block title %}Notifications{% endblock %}

{% block content %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-bell-fill me-2"></i> Notifications
        </h1>

        <div class="btn-group btn-group-sm">
            <a href="{% url 'users:user_detail' profile.username %}" class="btn btn-outline-secondary d-lg-none">
                <i class="bi bi-arrow-left"></i> {{ profile.full_name }}
            </a>
        </div>
    </div>
    <hr>

    <div class="btn-group btn-group-sm">
        <a onclick="return confirm('Mark as read?')" href="{% url "notices:notice_read_all" %}"
           class="btn btn-sm btn-outline-success {% if not profile.notices.new.exists %}disabled{% endif %}">Mark all as
            read <sup> {{ profile.notices.new.count }}</sup></a>
        <a onclick="return confirm('Are you sure?')" href="{% url "notices:notice_delete_all" %}"
           class="btn btn-sm btn-outline-danger {% if not has_notices %}disabled{% endif %}">Delete all
            <sup>{{ notice_count }}</sup></a>
    </div>
    <hr>

    {% if has_notices %}
        {% if page_obj.has_other_pages %} {% include "paginator.html" %} {% endif %}
        {% for notice in page_obj %}
            <div id="alert_{{ notice.id }}"
                 class="alert alert-{% if notice.is_read %}secondary{% else %}dark{% endif %}" role="alert" style="{% if notice.is_read %}opacity: 0.3{% endif %}">
                <small class="text-muted">{{ notice.get_notice_type_display }}</small>:
                <small class="text-muted">{{ notice.time_since }}</small>
                <hr>

                <div class="d-flex align-items-center mb-2">
                    <img src="{{ notice.sender.get_avatar_url }}" style="height: 50px"
                         class="figure-img img-thumbnail img-fluid rounded me-3" alt="Photo">
                    <div>
                        {% if notice.notice_type == 'like' %}
                            <div>
                                {{ notice.sender.full_name }} liked your
                                <strong>{{ notice.extra_data.object_type }}</strong>
                                {% if notice.content_object %}
                                    {% if notice.extra_data.content_type == 'imagefile' %}
                                        <a href="{% url 'user_images:public_image_list' notice.recipient.username %}#image-{{ notice.content_object.id }}"
                                           class="text-decoration-none">
                                            (view photo)
                                        </a>
                                    {% elif notice.extra_data.content_type == 'post' %}
                                        <a href="{{ notice.content_object.get_absolute_url }}"
                                           class="text-decoration-none">
                                            (view post)
                                        </a>
                                    {% elif notice.extra_data.content_type == 'comment' %}
                                        <a href="{{ notice.content_object.content_object.get_absolute_url }}#comment-{{ notice.content_object.id }}"
                                           class="text-decoration-none">
                                            (view comment)
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% elif notice.notice_type == 'comment' %}
                            <div>
                                {{ notice.sender.full_name }} commented on your
                                <strong>{{ notice.extra_data.content_type|pretty_content_type }}</strong>:
                                <div class="mt-1 p-2 bg-light rounded">
                                    "{{ notice.extra_data.comment_preview }}..."
                                </div>
                                {% if notice.content_object and notice.extra_data.content_type == 'post' %}
                                    <a href="{{ notice.content_object.get_absolute_url }}"
                                       class="text-decoration-none">
                                        (view full post)
                                    </a>
                                {% endif %}
                            </div>
                        {% else %}
                            {{ notice.message }}
                        {% endif %}
                    </div>
                </div>

                <hr>
                <div class="btn-group btn-group-sm">
                    {% if not notice.is_read %}
                        <button data-id="{{ notice.id }}" data-bs-toggle="tooltip" data-bs-placement="top"
                                title="Mark as read" class="btn btn-outline-secondary markAsRead">Mark as read
                        </button>
                    {% endif %}
                    <a data-bs-toggle="tooltip" data-bs-placement="top" title="{{ notice.sender.full_name }}"
                       href="{% url "users:user_detail" notice.sender.username %}"
                       class="btn btn-outline-info">{{ notice.sender.full_name }}</a>
                    <a data-bs-toggle="tooltip" data-bs-placement="top" title="Delete"
                       onclick="return confirm('Are you sure?')"
                       href="{% url "notices:notice_delete" notice.pk %}"
                       class="btn btn-outline-danger">Delete</a>
                </div>
            </div>
        {% endfor %}

        <hr>
        {% if page_obj.has_other_pages %} {% include "paginator.html" %} {% endif %}
    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-bell-slash fs-1 text-muted"></i>
            <p class="mt-3">No notifications yet</p>
        </div>
    {% endif %}

{% endblock %}

{% block js %}
    {% include "notices/_notice_list_js.html" %}
{% endblock %}