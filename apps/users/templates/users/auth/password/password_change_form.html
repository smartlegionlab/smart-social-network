{% extends 'base.html' %}

{% block title %}Change password{% endblock %}

{% block content %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-key me-2"></i> Change password:
        </h1>

        <div class="btn-group btn-group-sm">
            <a href="{% url 'users:user_detail' profile.username %}" class="btn btn-outline-secondary d-lg-none">
                <i class="bi bi-arrow-left"></i> {{ profile.full_name }}
            </a>
        </div>
    </div>
    <hr>

    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-secondary" id="generate-password"
                    {% if generate_blocked %}disabled data-blocked="true"{% endif %}>
                <span class="btn-text">
                    {% if generate_blocked %}Wait {{ generate_remaining }}s{% else %}Generate a strong
                        password{% endif %}
                </span>
                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
            <button class="btn btn-success" type="submit">Save</button>
        </div>
    </form>

{% endblock %}

{% block js %}
    <script>
        $(document).ready(function () {
            $('#id_old_password, #id_new_password1, #id_new_password2').addClass('form-control');

            const $btn = $('#generate-password');
            if ($btn.data('blocked')) {
                startCountdown($btn, parseInt($btn.find('.btn-text').text().match(/\d+/)[0]));
            }

            $btn.on('click', function () {
                if ($btn.data('blocked')) return;

                const $btnText = $btn.find('.btn-text');
                const $spinner = $btn.find('.spinner-border');

                $btn.prop('disabled', true);
                $btnText.text('Generating...');
                $spinner.removeClass('d-none');

                $.ajax({
                    url: '{% url "users:password_generate" %}',
                    method: 'GET',
                    success: function (data) {
                        $('#id_new_password1').val(data.password);
                        $('#id_new_password2').val(data.password);
                        startCountdown($btn, data.next_delay);
                    },
                    error: function () {
                        $btnText.text('Generate a strong password');
                        $btn.prop('disabled', false);
                    },
                    complete: function () {
                        $spinner.addClass('d-none');
                    }
                });
            });

            function startCountdown($btn, secondsLeft) {
                const $btnText = $btn.find('.btn-text');
                $btn.data('blocked', true);
                $btn.prop('disabled', true);

                $btnText.text(`Wait ${secondsLeft}s`);

                const countdown = setInterval(function () {
                    secondsLeft--;
                    $btnText.text(`Wait ${secondsLeft}s`);

                    if (secondsLeft <= 0) {
                        clearInterval(countdown);
                        $btn.data('blocked', false);
                        $btnText.text('Generate a strong password');
                        $btn.prop('disabled', false);
                    }
                }, 1000);
            }
        });
    </script>
{% endblock %}