{% extends "base.html" %}
{% block title %}Reset Password{% endblock %}
{% block main %}
    <div style="width: 70%; margin: 0 auto">
        <h1 class="display-6 text-center">Reset Password: </h1>
        <hr>
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Attention!</strong> The password will be reset and a temporary password will be sent to you only if
            your account has a Telegram ID and you are subscribed to the <a target="_blank" rel="noopener noreferrer"
                                                                            href="{{ site_config.telegram_bot_url }}">bot</a>.
            <p class="text-center">If you forgot your telegram ID, you can get it, for example, <a target="_blank" rel="noopener noreferrer"
                                                                                                   href="https://t.me/my_id_bot">here</a>.
            </p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        {% csrf_token %}
        <div class="mb-3">
            <label for="email" class="form-label">Email: <sup>*</sup></label>
            <input type="email" class="form-control" id="email" name="email" required>
        </div>
        <div class="mb-3">
            <label for="telegram_id" class="form-label">Telegram ID: <sup>*</sup></label>
            <input type="text" class="form-control" id="telegram_id" name="telegram_id" required>
        </div>
        <button id="resetPassword" type="button" class="btn btn-primary">Reset Password</button>

        <div id="response-message" class="mt-3"></div>
    </div>
{% endblock %}

{% block js %}
    <script>
        $(document).ready(function () {
            $('#resetPassword').on('click', function (event) {
                event.preventDefault();


                const email = $('#email').val();
                const telegramId = $('#telegram_id').val();

                if (!email || !telegramId) {
                    $('#response-message').html('<div class="alert alert-danger">Both fields are required.</div>');
                    return;
                }

                $(this).text('Wait...').addClass('disabled');

                $.ajax({
                    url: "{% url 'users:password_reset' %}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        email: email,
                        telegram_id: telegramId
                    }),
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function (data) {
                        if (data.success) {
                            $('#response-message').html('<div class="alert alert-success">Password reset link has been sent to your Telegram.</div>');
                            setTimeout(function () {
                                window.location.href = '{% url "users:login" %}';
                            }, 3000);
                        } else {
                            $('#response-message').html('<div class="alert alert-danger">' + data.error + '</div>');
                            setTimeout(function () {
                                location.reload();
                            }, 1000);
                        }
                    },
                    error: function (xhr, status, error) {
                        $('#response-message').html('<div class="alert alert-danger">An error occurred: ' + error + '</div>');
                    }
                });
            });
        });
    </script>
{% endblock %}
