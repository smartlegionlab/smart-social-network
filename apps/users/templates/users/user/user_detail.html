{% extends 'base.html' %}

{% block title %}{{ profile.full_name }}{% endblock %}

{% block content %}

    {% if not profile.is_active %}
        <div class="alert alert-danger" role="alert">
            <strong>Warning!</strong> User blocked!
        </div>
    {% endif %}

    <h1 class="display-6 text-center">
        {{ profile.full_name }}
        <sup style="font-size: 16px">
            {% if profile.is_online %}
                <i data-bs-toggle="tooltip" data-bs-placement="top" title="Online"
                   class="bi bi-circle-fill text-success"></i>
            {% else %}
                <i data-bs-toggle="tooltip" data-bs-placement="top" title="Offline"
                   class="bi bi-circle-fill text-danger"></i>
            {% endif %}
        </sup>
        {% if not is_owner and is_friend %}
            <sub>
            <span class="text-success">
                Friend
            </span>
            </sub>
        {% endif %}
    </h1>

    {% if not profile.is_online %}
        <p class="text-center text-danger">Last activity date: <span
            class="text-secondary">{{ profile.last_activity|timesince }}</span> ago</p>
    {% endif %}

    <hr>

    <div class="border p-3 mb-3 rounded" style="box-shadow: 0 0 5px #1b9dec">

        <ul class="list-group list-group-flush">

            <li class="list-group-item">
                <strong>Name:</strong>
                <span class="text-primary">
                    {{ profile.first_name }}
                </span>
            </li>

            <li class="list-group-item">
                <strong>Last name:</strong>
                <span class="text-primary">
                    {{ profile.last_name }}
                </span>
            </li>

            <li class="list-group-item">
                <strong>Username:</strong>
                <span class="text-primary">
                    @{{ profile.username }}
                </span>
            </li>

            <li class="list-group-item">
                <strong>City:</strong>
                <span class="text-primary">
                    {{ profile.optimized_city|default:"" }}
                </span>
            </li>

            <li class="list-group-item">
                <strong>Gender:</strong>
                <span class="text-primary">
                    {% if profile.gender == 'M' %}
                        <i style="cursor: help" data-bs-toggle="tooltip" data-bs-placement="top" title="Male"
                           class="bi bi-gender-male"></i>
                    {% elif profile.gender == 'F' %}
                        <i style="cursor: help" data-bs-toggle="tooltip" data-bs-placement="top" title="Female"
                           class="bi bi-gender-female"></i>
                    {% else %}
                        <i style="cursor: help" data-bs-toggle="tooltip" data-bs-placement="top" title="Not specified"
                           class="bi bi-patch-question-fill"></i>
                    {% endif %}
                </span>
            </li>

            <li class="list-group-item">
                <strong>About me:</strong> <span class="text-primary post-text"> {{ profile.about_me }}</span>
            </li>

            <li class="list-group-item">
                <strong>Date of Birth:</strong>
                <span class="text-primary">
                    {{ profile.date_of_birth|date:"d.m.Y"|default:"" }}
                </span>
            </li>

            <li class="list-group-item">
                <strong>Age:</strong>
                <span class="text-primary">
                    {{ profile.age|default:"" }}
                </span>
            </li>

            {% if is_owner %}

                <li class="list-group-item">
                    <strong>Email:</strong>
                    <span class="text-primary">
                        {{ profile.email|default:"" }}
                    </span>
                </li>

                <li class="list-group-item">
                    <strong>Phone:</strong>
                    <span class="text-primary">
                        {{ profile.phone|default:"" }}
                    </span>
                </li>

                <li class="list-group-item">
                    <strong>Telegram ID:</strong>
                    <span class="text-primary">
                        {% if profile.telegram_chat_id %}
                            {{ profile.telegram_chat_id }}
                        {% else %}
                            <span class="text-danger">
                                <strong>Attention! </strong>
                                <a href="{% url "users:user_update" %}">Add</a>
                                your
                                <a target="_blank" rel="noopener noreferrer" href="https://t.me/my_id_bot">
                                    Telegram chat ID</a>. It is needed to restore access to the account, as well as for two-factor authentication!
                            </span>
                        {% endif %}
                    </span>
                </li>

                <li class="list-group-item">
                    <strong>Two-factor authentication:</strong>
                    <span class="text-primary">
                    {% if profile.is_2fa_enabled %}
                        <i class="bi bi-check-circle text-success"></i>
                    {% else %}
                        <i class="bi bi-x-circle text-danger"></i>
                    {% endif %}
                </span>
                </li>

                <li class="list-group-item">
                    <strong>Account updated:</strong>
                    <span class="text-primary">
                        {{ profile.updated_at|date:"d.m.Y H:i:s" }}
                    </span>
                </li>

            {% endif %}

            <li class="list-group-item">
                <strong>Account created:</strong>
                <span class="text-primary">
                    {% if is_owner %}
                        {{ profile.created_at|date:"d.m.Y H:i:s" }}
                    {% else %}
                        {{ profile.created_at|timesince }} ago
                    {% endif %}
                </span>
            </li>

        </ul>
    </div>

    <hr>



<div class="post-form-container card mb-4">
    <form id="post-form" method="post" action="{% url 'posts:post_create' profile.username %}">
        {% csrf_token %}
        <input type="hidden" name="user_id" value="{{ profile.id }}">

        <div class="card-body">
            <div class="form-floating mb-3">
                <textarea name="content" class="form-control post-content"
                          placeholder="What's new with you?" id="postContent"
                          style="height: 100px" required></textarea>
                <label for="postContent">What's new with you?</label>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group" role="group">
                    <div class="dropdown" id="emojiDropdownContainer">
                        <button class="btn btn-outline-warning btn-sm dropdown-toggle" type="button"
                                id="emojiDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-emoji-smile"></i>
                        </button>
                        <div class="dropdown-menu p-2" aria-labelledby="emojiDropdownBtn"
                             style="width: 300px; max-height: 200px; overflow-y: auto;"
                             id="emojiDropdownMenu">
                            <div class="d-flex flex-wrap">
                                {% for emoji in emojis %}
                                    <button type="button" class="btn btn-sm border-0 emoji-btn"
                                            data-emoji="{{ emoji.code }}" title="{{ emoji.description }}"
                                            style="font-size: 1.2rem; padding: 0.25rem;">
                                        {{ emoji.code }}
                                    </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-outline-danger btn-sm" id="clear-post">
                        <i class="bi bi-eraser"></i>
                    </button>

                    <button type="submit" class="btn btn-primary btn-sm" id="submit-post" disabled>
                        <i class="bi bi-send"></i> Publish
                    </button>
                </div>
                {% if is_owner %}
            <a
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="Clear the wall"
                    id="btnClearAll"
                    onclick="return confirm('Are you sure?')"
                    href="{% url "posts:post_delete_all" %}"
                    class="btn btn-sm btn-outline-danger{% if not posts_exists %} disabled{% endif %}">
                <i class="bi bi-trash"></i> <sup id="postCount">{{ posts_count }}</sup>
            </a>
        {% endif %}
            </div>
        </div>
    </form>
</div>


    <hr>

    {% if posts_exists %}
        {% for post in page_obj %}
            <ul class="list-group">
                <li class="list-group-item post shadow" data-post-id="{{ post.id }}">

                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            {% if post.author.id != request.user.id %}
                                <a href="{% url 'users:user_detail' post.author.username %}"
                                   class="text-decoration-none">
                                    <img src="{{ post.author.get_avatar_url }}"
                                         class="rounded-circle me-3"
                                         alt="{{ post.author.full_name }}"
                                         style="width: 50px; height: 50px; object-fit: cover;">
                                </a>
                            {% else %}
                                <img src="{{ post.author.get_avatar_url }}"
                                     class="rounded-circle me-3"
                                     alt="{{ post.author.full_name }}"
                                     style="width: 50px; height: 50px; object-fit: cover;">
                            {% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0">
                                {% if post.author.id != request.user.id %}
                                    <a href="{% url 'users:user_detail' post.author.username %}"
                                       class="text-decoration-none" style="color: inherit;">
                                        <span class="text-primary">{{ post.author.full_name }}:</span>
                                    </a>
                                {% else %}
                                    <span class="text-success">You:</span>
                                {% endif %}
                            </h5>
                            <small class="text-muted">{{ post.created_at|timesince }} ago</small>
                        </div>
                    </div>

                    <hr>

                    <p class="post-text">{{ post.content }}</p>

                    <hr>

                    <div class="btn-group btn-group-sm">
                            <button id="like-btn-{{ post.id }}"
                                    class="btn btn-like {% if post.is_liked %}liked{% endif %}"
                                    data-post-id="{{ post.id }}"
                                    title="{% if post.is_liked %}Unlike{% else %}Like{% endif %}">
                                <i class="bi {% if post.is_liked %}bi-heart-fill{% else %}bi-heart{% endif %} like-icon"></i>
                                <sup id="like-count-{{ post.id }}">{{ post.like_count }}</sup>
                            </button>

                        {% if request.user.id == post.author.id %}
                            <button data-bs-toggle="tooltip" data-bs-placement="top" title="Edit post"
                                    class="btn btn-outline-warning edit-post-btn bi-pencil"
                                    data-post-id="{{ post.id }}">
                            </button>
                        {% endif %}
                        <a data-bs-toggle="tooltip" data-bs-placement="top" title="Comments to the post"
                           href="{% url "posts:post_comment_list" profile.username post.id %}"
                           class="btn btn-outline-secondary bi-chat-fill">
                            <sup>{{ post.comments.count }}</sup>
                        </a>
                        {% if is_owner or request.user.id == post.author.id %}
                            <button data-bs-toggle="tooltip" data-bs-placement="top" title="Delete post"
                                    data-post="{{ post.id }}" id="deletePost"
                                    class="btn btn-outline-danger post-delete bi-trash">
                            </button>
                        {% endif %}
                    </div>
                </li>
            </ul>
            <br>
        {% endfor %}

        {% if page_obj.has_other_pages %} {% include "paginator.html" %} {% endif %}

    {% else %}
        <div class="alert alert-primary" role="alert">
            There are no posts on the wall yet ...
        </div>
    {% endif %}

<div class="modal fade" id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPostModalLabel">Edit Post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editPostForm">
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" id="editPostId" name="post_id">

          <div class="form-floating mb-3">
            <textarea class="form-control" id="editPostContent" name="content"
                      style="height: 150px" required></textarea>
            <label for="editPostContent">Post content</label>
          </div>

          <div class="mb-3">
            <div class="dropdown">
              <button class="btn btn-outline-warning btn-sm dropdown-toggle" type="button"
                      id="editEmojiDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                      data-bs-auto-close="outside">
                <i class="bi bi-emoji-smile"></i> Add Emoji
              </button>
              <div class="dropdown-menu p-2" aria-labelledby="editEmojiDropdown"
                   style="width: 300px; max-height: 200px; overflow-y: auto;">
                <div class="d-flex flex-wrap">
                  {% for emoji in emojis %}
                    <button type="button" class="btn btn-sm border-0 emoji-edit-btn"
                            data-emoji="{{ emoji.code }}" title="{{ emoji.description }}"
                            style="font-size: 1.2rem; padding: 0.25rem;"
                            aria-label="Insert emoji {{ emoji.description }}">
                      {{ emoji.code }}
                    </button>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveEditBtn">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block js %}
    {% include "users/user/_user_detail_js.html" %}
{% endblock %}