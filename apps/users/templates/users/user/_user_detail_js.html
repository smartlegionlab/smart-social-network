<script>

    $( document ).ready(function() {

        const emojiDropdown = new bootstrap.Dropdown(document.getElementById('emojiDropdownBtn'));
    const emojiMenu = document.getElementById('emojiDropdownMenu');
    const postContent = $('#postContent');
    const submitBtn = $('#submit-post');

     $('.edit-post-btn').click(function() {
        const postId = $(this).data('post-id');
        const postContent = $('.post[data-post-id="' + postId + '"] .post-text').text();

        $('#editPostId').val(postId);
        $('#editPostContent').val(postContent);

        const editModal = new bootstrap.Modal(document.getElementById('editPostModal'), {
            focus: true
        });
        editModal.show();

        setTimeout(() => {
            $('#editPostContent').focus();
        }, 500);
    });

    $(document).on('click', '.emoji-edit-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const emoji = $(this).data('emoji');
        const textarea = $('#editPostContent');
        const startPos = textarea[0].selectionStart;
        const endPos = textarea[0].selectionEnd;
        const currentText = textarea.val();

        textarea.val(currentText.substring(0, startPos) + emoji + currentText.substring(endPos));
        textarea.focus();
        textarea[0].setSelectionRange(startPos + emoji.length, startPos + emoji.length);
    });

    $('#editPostForm').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);

        $.ajax({
            type: 'POST',
            url: "{% url 'posts:post_update' %}",
            data: form.serialize(),
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(response) {
                if (response.success) {
                    const postId = $('#editPostId').val();
                    $('.post[data-post-id="' + postId + '"] .post-text').text(response.content);

                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editPostModal'));
                    editModal.hide();

                    $('.edit-post-btn[data-post-id="' + postId + '"]').focus();
                } else {
                    alert('Error: ' + (response.error || 'Failed to update post'));
                    $('#saveEditBtn').focus();
                }
            },
            error: function() {
                alert('Server error');
                $('#saveEditBtn').focus();
            }
        });
    });

    function checkContent() {
        const content = postContent.val().trim();
        submitBtn.prop('disabled', content === '');
    }

    checkContent();

    postContent.on('input', checkContent);

    emojiMenu.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('#emojiDropdownContainer')) {
            emojiDropdown.hide();
        }
    });

    $('.emoji-btn').click(function() {
        const emoji = $(this).data('emoji');
        const startPos = postContent[0].selectionStart;
        const endPos = postContent[0].selectionEnd;
        const currentText = postContent.val();

        postContent.val(currentText.substring(0, startPos) + emoji + currentText.substring(endPos));
        postContent.focus();
        postContent[0].setSelectionRange(startPos + emoji.length, startPos + emoji.length);
        checkContent();
    });

    $('#clear-post').click(function() {
        postContent.val('').focus();
        checkContent();
    });

    $('#post-form').on('submit', function(e) {
    e.preventDefault();
    const content = postContent.val().trim();

    if (!content) {
        showAlert('danger', 'Please enter some text before posting', 3000);
        return;
    }

    $.ajax({
        type: 'POST',
        url: $(this).attr('action'),
        data: $(this).serialize(),
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        success: function(response) {
            if (response.success) {
                $('#post-form')[0].reset();
                submitBtn.prop('disabled', true);
                showAlert('success', 'Post created successfully!', 2000);
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('danger', 'Error: ' + (response.error || response.errors), 3000);
            }
        },
        error: function(xhr) {
            if (xhr.status === 429) {
                const response = JSON.parse(xhr.responseText);
                const retryTime = response.retry_after || 30;
                showAlert('warning',
                    `‚è≥ Limit exceeded. Try again in ${retryTime} seconds.`,
                    5000
                );
            } else {
                showAlert('danger', 'Server error. Please try again.', 3000);
            }
        }
    });
});

function showAlert(type, message, duration = 3000) {
    const existingAlerts = document.querySelectorAll('.custom-alert');
    for (let i = 0; i < existingAlerts.length; i++) {
        try {
            if (existingAlerts[i] && existingAlerts[i].parentNode) {
                existingAlerts[i].parentNode.removeChild(existingAlerts[i]);
            }
        } catch (e) {
            console.log('Error removing alert:', e);
        }
    }

    const alertHtml = `
        <div class="custom-alert alert alert-${type} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', alertHtml);

    if (duration > 0) {
        setTimeout(() => {
            const alerts = document.querySelectorAll('.custom-alert');
            if (alerts.length > 0) {
                try {
                    alerts[alerts.length - 1].remove();
                } catch (error) {
                    console.log('Error removing alert:', error);
                }
            }
        }, duration);
    }
}

if (!document.getElementById('alert-styles')) {
    const alertStyles = `
    .custom-alert {
        animation: slideInRight 0.3s ease-out;
        background-color: #000000 !important;
        border: 2px solid #28a745 !important;
        border-radius: 10px !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4) !important;
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .alert-warning {
        background-color: #000000 !important;
        border: 2px solid #ffc107 !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4) !important;
    }

    .alert-success {
        background-color: #000000 !important;
        border: 2px solid #28a745 !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4) !important;
    }

    .alert-danger {
        background-color: #000000 !important;
        border: 2px solid #dc3545 !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4) !important;
    }

    .custom-alert .btn-close {
        filter: invert(1) brightness(2);
    }
    `;

    const style = document.createElement('style');
    style.id = 'alert-styles';
    style.textContent = alertStyles;
    document.head.appendChild(style);
}


        $('#changePhotoBtn').click(function () {
            $('#uploadForm').toggle();
        });

        $('#resetPhoto').on('click', function () {
            if (confirm('Are you sure you want to remove your profile photo and set it to default avatar?')) {
                $.ajax({
                    url: "{% url 'users:avatar_reset' %}",
                    type: "POST",
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        alert(`Error! ${error}`);
                    }
                });
            }
        });

        $('.post-delete').on('click', function () {
            if (confirm('Are you sure you want to delete this post?')) {
                const postId = this.dataset.post;

                $.ajax({
                    url: "{% url 'posts:post_delete' %}",
                    type: "POST",
                    data: {
                        'post_id': postId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        showAlert('danger', 'Error deleting post');
                    }
                });
            }
        });

$('.btn-like').click(async function(e) {
    e.preventDefault();
    e.stopPropagation();

    const btn = $(this);
    const icon = btn.find('.like-icon');
    const postId = btn.data('post-id');
    const likeCount = $(`#like-count-${postId}`);

    icon.css('animation', 'none');
    void icon[0].offsetWidth;
    icon.addClass('heart-beat');
    icon.css('animation', 'heartBeat 0.6s cubic-bezier(0.4, 0, 0.2, 1)');

    try {
        const response = await fetch("{% url 'posts:post_like_toggle' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'post_id': postId,
            })
        });

        const data = await response.json();

        if (data.limit_reached) {
            showAlert('warning', data.error, 3000);
            return;
        }

        if (data.success) {
            btn.toggleClass('liked');
            btn.attr('title', data.liked ? 'Unlike' : 'Like');
            icon.toggleClass('bi-heart bi-heart-fill');
            likeCount.text(data.likes_count);

            showAlert('success', data.liked ? 'Liked!' : 'Unliked!', 1000);
        } else {
            showAlert('danger', data.error || 'Error processing like', 3000);
        }

    } catch (error) {
        console.log('Like error:', error);
        showAlert('danger', 'Network error. Please try again.', 3000);
    }
});

    });

    </script>