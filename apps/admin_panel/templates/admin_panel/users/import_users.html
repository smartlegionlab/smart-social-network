{% extends "base.html" %}
{% load static %}

{% block sidebar %}
    {% include "admin_panel/_admin_sidebar.html" with active_page='profiles' %}
{% endblock %}

{% block content %}




    <style>
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        .progress-text {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 600;
            color: #000;
        }

        .alert-danger ul {
            margin-bottom: 0;
        }

        .progress-bar.bg-danger {
            background-color: #dc3545 !important;
        }

        .progress-bar.bg-success {
            background-color: #28a745 !important;
        }
    </style>

    <div class="container mt-4">
        <h2 class="display-6 text-center">Import Profiles</h2>
        <hr>

        <div class="alert alert-info">
            <strong>Important:</strong> Please make sure your file matches the selected format.
        </div>

        <div id="format-error" class="alert alert-danger d-none mt-2">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="format-error-message"></span>
        </div>

        <div id="global-error-container" class="alert alert-danger d-none mt-2">
            <i class="bi bi-x-circle me-2"></i>
            <span id="global-error-message"></span>
        </div>

        <div id="import-container">
            <div id="import-form-container">
                <div class="card shadow">
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data" id="importForm"
                              action="{% url 'admin_panel:start_import' %}">
                            {% csrf_token %}

                            <div class="mb-4">
                                <label for="format" class="form-label">Import Format</label>
                                <select class="form-select form-select-lg" id="format" name="format" required>
                                    <option value="">Choose format...</option>
                                    <option value="csv">CSV</option>
                                    <option value="json">JSON</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label for="file" class="form-label">Select File</label>
                                <input type="file" class="form-control form-control-lg"
                                       id="file" name="file" required
                                       accept=".csv,.json,text/csv,application/json">
                                <div class="form-text">
                                    Maximum file size: 100MB. Supported formats: CSV, JSON
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{% url 'admin_panel:admin_user_list' %}"
                                   class="btn btn-outline-secondary btn-lg">
                                    <i class="bi bi-arrow-left-circle me-2"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="bi bi-cloud-upload me-2"></i>Start Import
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card shadow mt-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Import Instructions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="bi bi-filetype-csv me-2"></i>CSV Format</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">Header row required</li>
                                    <li class="list-group-item">Columns: email, first_name, last_name</li>
                                    <li class="list-group-item">Date format: YYYY-MM-DD</li>
                                </ul>
                                <a onclick="return confirm('Are you sure?')"
                                    href="{% url 'admin_panel:admin_export_users' 'csv' %}"
                                    class="btn btn-outline-success me-3">
                                        <i class="bi bi-download me-2"></i>Download CSV Template
                                </a>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="bi bi-filetype-json me-2"></i>JSON Format</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">Array of objects</li>
                                    <li class="list-group-item">UTF-8 encoding</li>
                                    <li class="list-group-item">Max 100k records</li>
                                </ul>
                                <a onclick="return confirm('Are you sure?')"
                                    href="{% url 'admin_panel:admin_export_users' 'json' %}"
                                    class="btn btn-outline-success">
                                        <i class="bi bi-download me-2"></i>Download JSON Template
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="import-progress-container" class="d-none mt-5">
                <div class="card shadow">
                    <div class="card-body">
                        <h4 class="card-title mb-4">
                            <i class="bi bi-clock-history me-2"></i>Import Progress
                        </h4>

                        <div class="progress mb-4" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: 0%"
                                 aria-valuenow="0"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                <span class="progress-text">0%</span>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="p-3 border rounded text-center">
                                    <h6 class="text-muted">Total</h6>
                                    <h3 class="mb-0" id="totalCount">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 border rounded text-center">
                                    <h6 class="text-muted">Processed</h6>
                                    <h3 class="mb-0" id="processedCount">0</h3>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="p-3 border rounded text-center">
                                    <h6 class="text-muted">Created</h6>
                                    <h3 class="mb-0 text-success" id="createdCount">0</h3>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="p-3 border rounded text-center">
                                    <h6 class="text-muted">Updated</h6>
                                    <h3 class="mb-0 text-warning" id="updatedCount">0</h3>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="p-3 border rounded text-center">
                                    <h6 class="text-muted">Errors</h6>
                                    <h3 class="mb-0 text-danger" id="errorCount">0</h3>
                                </div>
                            </div>
                        </div>

                        <div id="critical-error-container" class="alert alert-danger d-none">
                            <h5><i class="bi bi-x-circle me-2"></i>Critical Error</h5>
                            <p id="critical-error-message" class="mb-0"></p>
                        </div>

                        <div id="row-errors-container" class="alert alert-danger d-none mt-2">
                            <h5><i class="bi bi-exclamation-triangle me-2"></i>Errors during import</h5>
                            <ul id="row-errors-list" class="mb-0"></ul>
                        </div>

                        <div id="results-container" class="d-none">
                            <div class="alert alert-success">
                                <h5><i class="bi bi-check-circle me-2"></i>Import Completed!</h5>
                                <div class="mt-3">
                                    <a href="{% url 'admin_panel:admin_user_list' %}"
                                       class="btn btn-success me-2">
                                        <i class="bi bi-people me-2"></i>View Profiles
                                    </a>
                                    <button onclick="location.reload()"
                                            class="btn btn-outline-primary">
                                        <i class="bi bi-arrow-repeat me-2"></i>Import More
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script>
        $(document).ready(function () {
            const $formatSelect = $('#format');
            const $fileInput = $('#file');
            const $errorContainer = $('#format-error');
            const $errorMessage = $('#format-error-message');

            $formatSelect.on('change', function () {
                if ($(this).val() === 'csv') {
                    $fileInput.attr('accept', '.csv,text/csv');
                } else if ($(this).val() === 'json') {
                    $fileInput.attr('accept', '.json,application/json');
                } else {
                    $fileInput.removeAttr('accept');
                }
                $fileInput.val('');
            });

            $fileInput.on('change', function () {
                if (this.files.length > 0) {
                    const fileName = this.files[0].name.toLowerCase();
                    if (fileName.endsWith('.csv')) {
                        $formatSelect.val('csv');
                    } else if (fileName.endsWith('.json')) {
                        $formatSelect.val('json');
                    }
                }
            });

            $('#importForm').on('submit', async function (e) {
                e.preventDefault();
                $('.alert-danger').addClass('d-none');
                $errorContainer.addClass('d-none');

                const form = this;
                const format = form.elements['format'].value;
                const file = form.elements['file'].files[0];
                const $submitBtn = $('#submitBtn');

                if (file) {
                    const fileName = file.name.toLowerCase();
                    const isCsvWithJson = format === 'csv' && fileName.endsWith('.json');
                    const isJsonWithCsv = format === 'json' && fileName.endsWith('.csv');

                    if (isCsvWithJson || isJsonWithCsv) {
                        $errorMessage.text(`Selected ${format.toUpperCase()} format but uploaded ${fileName.split('.').pop().toUpperCase()} file`);
                        $errorContainer.removeClass('d-none');
                        return;
                    }

                    if (file.size > 100 * 1024 * 1024) {
                        $errorMessage.text('File size exceeds 100MB limit');
                        $errorContainer.removeClass('d-none');
                        return;
                    }
                }

                $submitBtn.prop('disabled', true).html(`
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Processing...
        `);

                try {
                    const formData = new FormData(form);
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        }
                    });

                    if (!response.ok) {
                        let errorMessage = `Error ${response.status}`;
                        const contentType = response.headers.get('content-type');

                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorMessage;
                        } else {
                            errorMessage = await response.text() || errorMessage;
                        }

                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    $('#import-form-container').addClass('d-none');
                    $('#import-progress-container').removeClass('d-none');
                    trackImportProgress(data.task_id);

                } catch (error) {
                    showGlobalError(error.message);
                    $submitBtn.prop('disabled', false).html(`<i class="bi bi-cloud-upload me-2"></i>Try again`);
                }
            });

            function showGlobalError(message) {
                $('#global-error-message').text(message);
                $('#global-error-container').removeClass('d-none');
            }

            function trackImportProgress(taskId) {
                const progressUrl = `/admin-panel/users/import/${taskId}/status/`;
                const $progressBar = $('.progress-bar');
                const $progressText = $('.progress-text');

                const updateInterval = 1000;
                let retryCount = 0;

                const updateProgress = async () => {
                    try {
                        const response = await fetch(progressUrl);
                        if (!response.ok) throw new Error('Network error');

                        const data = await response.json();
                        const total = data.total || 1;
                        const processed = data.processed || 0;
                        const progress = Math.min(Math.round((processed / total) * 100), 100);

                        $progressBar.css('width', `${progress}%`);
                        $progressText.text(`${progress}%`);

                        $('#totalCount').text(total);
                        $('#processedCount').text(processed);
                        $('#createdCount').text(data.created || 0);
                        $('#errorCount').text(data.errors?.length || 0);
                        $('#updatedCount').text(data.updated || 0);

                        if (data.errors?.length > 0) {
                            showRowErrors(data.errors);
                        }

                        if (data.status === 'SUCCESS') {
                            finalizeImport(true);
                        } else if (data.status === 'FAILURE') {
                            finalizeImport(false, data.error);
                        } else {
                            setTimeout(updateProgress, updateInterval);
                        }

                    } catch (error) {
                        if (retryCount < 3) {
                            retryCount++;
                            setTimeout(updateProgress, updateInterval * 2);
                        } else {
                            finalizeImport(false, 'Connection lost. Please check import status later.');
                        }
                    }
                };

                updateProgress();
            }

            function finalizeImport(success, errorMessage = null) {
                const $progressBar = $('.progress-bar');
                $progressBar.removeClass('progress-bar-animated');

                if (success) {
                    $progressBar.addClass('bg-success');
                    $('#results-container').removeClass('d-none');
                } else {
                    $progressBar.addClass('bg-danger');
                    if (errorMessage) {
                        showCriticalError(errorMessage);
                    }
                }
            }

            function showCriticalError(message) {
                $('#critical-error-message').text(message);
                $('#critical-error-container').removeClass('d-none');
            }

            function showRowErrors(errors) {
                const $list = $('#row-errors-list').empty();
                errors.slice(0, 20).forEach(error => {
                    $list.append($('<li>').text(`${error.row || 'N/A'}: ${error.error}`));
                });
                $('#row-errors-container').removeClass('d-none');
            }
        });
    </script>
{% endblock %}