{% extends "base.html" %}
{% load user_images_tags %}
{% load user_files_tags %}
{% load static %}

{% block title %}{{ image.title|default:"Image" }} by {{ image.uploaded_by.full_name }}{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'vendors/glightbox.min.css' %}">
<link rel="stylesheet" href="{% static 'vendors/animate.min.css' %}">
<style>
:root {
    --image-bg-dark: #1a1a1a;
    --card-bg-dark: #2d2d2d;
    --text-dark: #e0e0e0;
    --border-dark: #444;
}

.image-detail-container {
    max-width: 1200px;
    margin: 2rem auto;
}

.image-card {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    margin-bottom: 2rem;
    background-color: var(--card-bg-dark);
    border: 1px solid var(--border-dark);
}

.image-wrapper {
    position: relative;
    background: var(--image-bg-dark);
    min-height: 500px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.image-wrapper img {
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
    filter: brightness(0.95);
}

.image-meta {
    padding: 1.5rem;
    color: var(--text-dark);
}

.image-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.comments-section {
    background: var(--card-bg-dark);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    border: 1px solid var(--border-dark);
    color: var(--text-dark);
}

.comment-form textarea {
    border-radius: 12px;
    resize: none;
    min-height: 100px;
    background-color: #333;
    border-color: #444;
    color: white;
}

.comment-form textarea:focus {
    background-color: #333;
    color: white;
    border-color: #555;
}

.comment {
    padding: 1rem 0;
    border-bottom: 1px solid var(--border-dark);
}

.comment:last-child {
    border-bottom: none;
}

.author-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.author-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.like-btn {
    transition: all 0.3s ease;
    background: transparent;
    border: none;
    color: #ccc;
}

.like-btn.liked {
    color: #ff6b6b !important;
}

.like-btn:hover {
    transform: scale(1.1);
}

.btn-like {
    transition: all 0.2s ease;
    border: none;
    background: transparent;
    color: var(--bs-secondary);
}

.btn-like:hover {
    transform: scale(1.1);
}

.btn-like.liked {
    color: #dc3545;
}

.btn-like:focus {
    box-shadow: none;
}

.like-count {
    margin-left: 0.3rem;
    font-size: 0.9rem;
}

.dropdown-menu {
    background-color: #333;
    border: 1px solid #444;
}

.dropdown-item {
    color: #e0e0e0;
}

.dropdown-item:hover {
    background-color: #444;
    color: white;
}

.text-muted {
    color: #aaa !important;
}

.btn-outline-secondary {
    border-color: #666;
    color: #ccc;
}

.btn-outline-secondary:hover {
    background-color: #444;
    border-color: #777;
    color: white;
}

@media (max-width: 768px) {
    .image-wrapper {
        min-height: 300px;
    }

    .image-actions {
        flex-wrap: wrap;
    }
}

.gslide-description {
    background: rgba(0, 0, 0, 0.8) !important;
    color: white !important;
}

.gclose {
    color: white !important;
}

.visibility-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    opacity: 0.9;
}

.comment-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.comment-actions a, .comment-actions button {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

.btn-like-comment {
    transition: all 0.3s ease;
    border: 1px solid var(--border-dark) !important;
    background-color: transparent !important;
    color: var(--bs-secondary) !important;
    padding: 0.25rem 0.5rem !important;
    font-size: 0.9rem !important;
    line-height: 1 !important;
}

.btn-like-comment:hover {
    transform: scale(1.1) !important;
    color: #dc3545 !important;
    border-color: #dc3545 !important;
}

.btn-like-comment.liked {
    color: #dc3545 !important;
    border-color: #dc3545 !important;
}

.btn-like-comment:focus {
    box-shadow: none !important;
    outline: none !important;
}

</style>
{% endblock %}

{% block content %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-image-fill me-2"></i> {{ image.title|default:"Image" }} by {{ image.uploaded_by.full_name }}
        </h1>
        <div class="btn-group btn-group-sm">
            <a href="{% url 'user_images:public_image_list' profile.username %}" class="btn btn-outline-secondary d-lg-none">
                <i class="bi bi-arrow-left"></i> Images
            </a>
        </div>
    </div>
    <hr>

<div class="image-detail-container">
    <div class="image-card">
        <div class="image-wrapper">
            {% if is_owner %}
            <span class="badge visibility-badge bg-{% if image.is_visible %}success{% else %}secondary{% endif %}">
                <i class="bi bi-eye{% if not image.is_visible %}-slash{% endif %}"></i>
            </span>
            {% endif %}

            <a href="{{ image.image.url }}" class="glightbox" data-title="{{ image.title }}" data-description="{{ image.description }}">
                <img src="{{ image.image.url }}" alt="{{ image.title }}" loading="lazy">
            </a>
        </div>

        <div class="image-meta">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="author-badge">
                    <img src="{{ image.uploaded_by.get_avatar_url }}" alt="{{ image.uploaded_by.full_name }}" class="author-avatar">
                    <div>
                        <h5 class="mb-0 text-light">{{ image.uploaded_by.full_name }}</h5>
                        <small class="text-muted">{{ image.uploaded_at|timesince }} ago</small>
                    </div>
                </div>

                {% if is_owner %}
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-warning edit-btn"
                            data-id="{{ image.id }}"
                            data-title="{{ image.title }}"
                            data-description="{{ image.description }}"
                            data-is-visible="{{ image.is_visible|lower }}">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <a href="{% url 'user_images:image_delete' image.pk %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">
                        <i class="bi bi-trash"></i>
                    </a>
                </div>
                {% endif %}
            </div>

            {% if image.title %}
            <h3 class="text-light">{{ image.title }}</h3>
            {% endif %}

            {% if image.description %}
            <p class="text-muted">{{ image.description }}</p>
            {% endif %}

            <div class="image-actions">
                {% check_image_like request.user.id image as is_liked %}
                <button class="btn btn-like {% if is_liked %}liked btn-danger{% else %}btn-outline-secondary{% endif %}"
                        data-image-id="{{ image.id }}"
                        id="like-btn">
                    <i class="bi {% if is_liked %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                    <span id="like-count">{{ image.likes.count }}</span>
                </button>

                <button class="btn btn-outline-secondary" data-bs-toggle="collapse" href="#commentForm">
                    <i class="bi bi-chat-left-text"></i> Add Comment
                </button>

                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-share"></i> Share
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="navigator.clipboard.writeText('{{ request.build_absolute_uri }}'); return false;">
                            <i class="bi bi-link-45deg"></i> Copy link
                        </a></li>
                    </ul>
                </div>
            </div>

            <div class="collapse" id="commentForm">
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <form id="comment-form" method="post" action="{% url 'user_images:image_comment_create' image.id %}">
                            {% csrf_token %}
                            <div class="form-floating mb-3">
                                <textarea name="content" class="form-control comment-content"
                                          placeholder="Your comment" id="commentContent"
                                          style="height: 100px" required></textarea>
                                <label for="commentContent">Your comment</label>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group">
                                    <div class="dropdown" id="commentEmojiDropdownContainer">
                                        <button class="btn btn-outline-warning btn-sm dropdown-toggle" type="button"
                                                id="commentEmojiDropdownBtn" data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            <i class="bi bi-emoji-smile"></i>
                                        </button>
                                        <div class="dropdown-menu p-2" aria-labelledby="commentEmojiDropdownBtn"
                                             style="width: 300px; max-height: 200px; overflow-y: auto;"
                                             id="commentEmojiDropdownMenu">
                                            <div class="d-flex flex-wrap">
                                                {% for emoji in emojis %}
                                                    <button type="button" class="btn btn-sm border-0 comment-emoji-btn"
                                                            data-emoji="{{ emoji.code }}" title="{{ emoji.description }}"
                                                            style="font-size: 1.2rem; padding: 0.25rem;">
                                                        {{ emoji.code }}
                                                    </button>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>

                                    <button type="button" class="btn btn-outline-danger btn-sm" id="clear-comment">
                                        <i class="bi bi-trash"></i> Clear
                                    </button>
                                </div>

                                <button type="submit" class="btn btn-sm btn-primary" id="submit-comment" disabled>
                                    <i class="bi bi-send"></i> Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="comments-section">
        <h5 class="text-light"><i class="bi bi-chat-square-text"></i> Comments <sup>{{ image.comments.count }}</sup></h5>
        <hr>
        <div id="comments-list">
            {% for comment in page_obj %}
                <div class="card mb-3 comment" data-comment-id="{{ comment.id }}"
                     style="box-shadow: 0 0 5px #41464b">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <a href="{% url "users:user_detail" comment.author.username %}">
                                <img src="{{ comment.author.get_avatar_url }}"
                                 class="rounded-circle me-3 object-fit-cover"
                                 width="40" height="40"
                                 alt="{{ comment.author.full_name }}">
                            </a>
                            <div class="flex-grow-1">
                                <a style="text-decoration: none" href="{% url "users:user_detail" comment.author.username %}">
                                    <h6 class="mb-0">{{ comment.author.full_name }}</h6>
                                </a>
                                <small class="text-muted">Created {{ comment.created_at|timesince }} ago{% if comment.is_edit %} | Edited {{ comment.edited_at|timesince }} ago{% endif %}</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button id="like-btn-{{ comment.id }}"
                                        class="btn btn-like-comment {% if comment.is_liked %}liked{% endif %}"
                                        data-comment-id="{{ comment.id }}"
                                        title="{% if comment.is_liked %}Unlike{% else %}Like{% endif %}">
                                    <i class="bi {% if comment.is_liked %}bi-heart-fill{% else %}bi-heart{% endif %} like-icon"></i>
                                    <sup id="like-count-{{ comment.id }}">{{ comment.like_count }}</sup>
                                </button>

                                {% if request.user.is_superuser or comment.author == request.user or is_owner %}
                                    {% if comment.author == request.user %}
                                        <button class="btn btn-sm btn-outline-warning edit-comment"
                                                data-comment-id="{{ comment.id }}"
                                                data-bs-toggle="tooltip" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-danger delete-comment"
                                            data-comment-id="{{ comment.id }}"
                                            data-bs-toggle="tooltip" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        <hr>
                        <p class="mb-0 comment-content text-light" style="white-space: pre-line">{{ comment.content|urlize|linebreaksbr }}</p>
                    </div>
                </div>
            {% empty %}
                <div class="alert alert-primary">No comments yet</div>
            {% endfor %}
            {% if page_obj.has_other_pages %}
                <div class="mt-5">
                    {% include "paginator.html" %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="imageId" name="image_id">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="isVisible" name="is_visible" value="true">
                            <label class="form-check-label" for="isVisible">Visible to others</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveChanges">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editCommentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="edit-comment-form">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" id="edit-comment-id" name="comment_id">

                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="edit-comment-content"
                                  name="content" style="height: 150px; white-space: pre-line" required></textarea>
                        <label for="edit-comment-content">Comment text</label>
                    </div>

                    <div class="mb-3">
                        <div class="dropdown" id="editCommentEmojiDropdownContainer">
                            <button class="btn btn-outline-warning btn-sm dropdown-toggle" type="button"
                                    id="editCommentEmojiDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false"
                                    data-bs-auto-close="outside">
                                <i class="bi bi-emoji-smile"></i> Add Emoji
                            </button>
                            <div class="dropdown-menu p-2" aria-labelledby="editCommentEmojiDropdownBtn"
                                style="width: 300px; max-height: 200px; overflow-y: auto;">
                                <div class="d-flex flex-wrap">
                                    {% for emoji in emojis %}
                                        <button type="button" class="btn btn-sm border-0 edit-comment-emoji-btn"
                                                data-emoji="{{ emoji.code }}" title="{{ emoji.description }}"
                                                style="font-size: 1.2rem; padding: 0.25rem;">
                                            {{ emoji.code }}
                                        </button>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-comment-changes">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="{% static 'vendors/glightbox.min.js' %}"></script>
<script>

function showAlert(type, message, duration = 3000) {
    document.querySelectorAll('.custom-alert').forEach(alert => alert.remove());

    const alertHtml = `
        <div class="custom-alert alert alert-${type} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', alertHtml);

    if (duration > 0) {
        setTimeout(() => {
            const alert = document.querySelector('.custom-alert');
            if (alert) {
                bootstrap.Alert.getOrCreateInstance(alert).close();
            }
        }, duration);
    }
}

if (!document.getElementById('alert-styles')) {
    const alertStyles = `
    .custom-alert {
        animation: slideInRight 0.3s ease-out;
        background-color: #000000 !important;
        border: 2px solid #28a745 !important;
        border-radius: 10px !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4) !important;
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .alert-warning {
        background-color: #000000 !important;
        border: 2px solid #ffc107 !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4) !important;
    }

    .alert-success {
        background-color: #000000 !important;
        border: 2px solid #28a745 !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4) !important;
    }

    .alert-danger {
        background-color: #000000 !important;
        border: 2px solid #dc3545 !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4) !important;
    }

    .custom-alert .btn-close {
        filter: invert(1) brightness(2);
    }
    `;

    const style = document.createElement('style');
    style.id = 'alert-styles';
    style.textContent = alertStyles;
    document.head.appendChild(style);
}

document.addEventListener('DOMContentLoaded', function() {
    const lightbox = GLightbox({
        selector: '.glightbox',
        touchNavigation: true,
        loop: true,
        zoomable: true,
        skin: 'dark'
    });

    const commentContent = document.getElementById('commentContent');
    const commentSubmitBtn = document.getElementById('submit-comment');
    const editCommentContent = document.getElementById('edit-comment-content');
    const saveCommentChangesBtn = document.getElementById('save-comment-changes');

    function checkCommentContent() {
        const content = commentContent.value.trim();
        commentSubmitBtn.disabled = content === '';
    }

    function checkEditCommentContent() {
        const content = editCommentContent.value.trim();
        saveCommentChangesBtn.disabled = content === '';
    }

    if (commentContent && commentSubmitBtn) {
        checkCommentContent();
        commentContent.addEventListener('input', checkCommentContent);
    }

    if (editCommentContent && saveCommentChangesBtn) {
        editCommentContent.addEventListener('input', checkEditCommentContent);
    }

    const likeBtn = document.getElementById('like-btn');
    if (likeBtn) {
        likeBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            const btn = this;
            const imageId = btn.dataset.imageId;
            const icon = btn.querySelector('i');
            const likeCount = btn.querySelector('span');

            btn.classList.add('animate__animated', 'animate__pulse');

            try {

                const response = await fetch("{% url 'user_images:image_like_toggle' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `image_id=${imageId}`
                });

                const data = await response.json();

                if (data.limit_reached) {
                    showAlert('warning', data.error, 3000);
                    return;
                }

                if (data.success) {
                    btn.classList.toggle('btn-outline-secondary');
                    btn.classList.toggle('btn-danger');
                    btn.classList.toggle('liked');
                    icon.classList.toggle('bi-heart');
                    icon.classList.toggle('bi-heart-fill');

                    if (likeCount) {
                        likeCount.textContent = data.likes_count;
                    }

                    btn.title = data.liked ? 'Unlike' : 'Like';

                    showAlert('success', data.liked ? 'Liked!' : 'Unliked!', 1000);

                } else {
                    showAlert('danger', data.error || 'Error processing like', 3000);
                }

        } catch (error) {
            console.log('Like error:', error);
            showAlert('danger', 'Network error. Please try again.', 3000);
        } finally {
            setTimeout(() => {
                btn.classList.remove('animate__animated', 'animate__pulse');
            }, 1000);
        }
        });
    }

    const commentEmojiDropdown = new bootstrap.Dropdown(document.getElementById('commentEmojiDropdownBtn'));
    const commentEmojiMenu = document.getElementById('commentEmojiDropdownMenu');

    document.querySelectorAll('.comment-emoji-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const emoji = this.dataset.emoji;
            const textarea = document.getElementById('commentContent');
            const startPos = textarea.selectionStart;
            const endPos = textarea.selectionEnd;
            const currentText = textarea.value;

            textarea.value = currentText.substring(0, startPos) + emoji + currentText.substring(endPos);
            textarea.focus();
            textarea.setSelectionRange(startPos + emoji.length, startPos + emoji.length);
            checkCommentContent();
        });
    });

    commentEmojiMenu.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    document.getElementById('clear-comment').addEventListener('click', function() {
        document.getElementById('commentContent').value = '';
        document.getElementById('commentContent').focus();
        checkCommentContent();
    });

    document.getElementById('comment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const content = commentContent.value.trim();

        if (!content) {
            alert('Please enter some text before posting');
            return;
        }

        const form = this;

        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new FormData(form)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
               let currentUrl = window.location.href;
               let newUrl = currentUrl.split('?')[0];
               window.location.href = newUrl;
            } else {
                alert('Error: ' + (data.error || 'Server error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Server error');
        });
    });

    document.querySelectorAll('.btn-like-comment').forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();

            const btn = this;
            const commentId = btn.dataset.commentId;
            const icon = btn.querySelector('.like-icon');
            const likeCount = document.getElementById(`like-count-${commentId}`);

            btn.classList.add('animate__animated', 'animate__pulse');

            try {

                const response = await fetch("{% url 'user_images:image_comment_like_toggle' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `comment_id=${commentId}`
                })

                const data = await response.json();

                if (data.limit_reached) {
                    showAlert('warning', data.error, 3000);
                    return;
                }

                if (data.success) {
                    btn.classList.toggle('liked');
                    btn.title = data.liked ? 'Unlike' : 'Like';
                    icon.classList.toggle('bi-heart');
                    icon.classList.toggle('bi-heart-fill');
                    likeCount.textContent = data.likes_count;

                    if (likeCount) {
                        likeCount.textContent = data.likes_count;
                    }

                    btn.title = data.liked ? 'Unlike' : 'Like';

                    showAlert('success', data.liked ? 'Liked!' : 'Unliked!', 1000);

                } else {
                    showAlert('danger', data.error || 'Error processing like', 3000);
                }

        } catch (error) {
            console.log('Like error:', error);
            showAlert('danger', 'Network error. Please try again.', 3000);
        } finally {
            setTimeout(() => {
                btn.classList.remove('animate__animated', 'animate__pulse');
            }, 1000);
        }
        });
    });

    document.querySelectorAll('.delete-comment').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();

            if (!confirm('Are you sure you want to delete this comment?')) return;

            const commentId = this.dataset.commentId;

            fetch(`{% url 'user_images:image_comment_delete' 0 %}`.replace('0', commentId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Error deleting comment');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Server error');
            });
        });
    });

    document.querySelectorAll('.edit-comment').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            const commentContent = document.querySelector(`.comment[data-comment-id="${commentId}"] .comment-content`).textContent;

            document.getElementById('edit-comment-id').value = commentId;
            document.getElementById('edit-comment-content').value = commentContent;

            const modal = new bootstrap.Modal(document.getElementById('editCommentModal'));
            modal.show();

            setTimeout(() => {
                document.getElementById('edit-comment-content').focus();
                checkEditCommentContent();
            }, 500);
        });
    });

    document.querySelectorAll('.edit-comment-emoji-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const emoji = this.dataset.emoji;
            const textarea = document.getElementById('edit-comment-content');
            const startPos = textarea.selectionStart;
            const endPos = textarea.selectionEnd;
            const currentText = textarea.value;

            textarea.value = currentText.substring(0, startPos) + emoji + currentText.substring(endPos);
            textarea.focus();
            textarea.setSelectionRange(startPos + emoji.length, startPos + emoji.length);
            checkEditCommentContent();
        });
    });

    document.getElementById('edit-comment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const content = editCommentContent.value.trim();

        if (!content) {
            alert('Please enter some text before saving');
            return;
        }

        const commentId = document.getElementById('edit-comment-id').value;

        fetch(`{% url 'user_images:image_comment_update' 0 %}`.replace('0', commentId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new FormData(this)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Server error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Server error');
        });
    });

    {% if is_owner %}
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    const editButton = document.querySelector('.edit-btn');

    if (editButton) {
        editButton.addEventListener('click', function() {
            document.getElementById('imageId').value = this.dataset.id;
            document.getElementById('title').value = this.dataset.title || '';
            document.getElementById('description').value = this.dataset.description || '';
            document.getElementById('isVisible').checked = this.dataset.isVisible === 'true';
            editModal.show();
        });
    }

    document.getElementById('saveChanges').addEventListener('click', function() {
        const formData = new FormData();
        formData.append('image_id', document.getElementById('imageId').value);
        formData.append('title', document.getElementById('title').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('is_visible', document.getElementById('isVisible').checked ? 'true' : 'false');

        fetch("{% url 'user_images:image_update' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (!data.is_visible) {
                window.location.href = "{% url 'user_images:user_image_list' %}";
            } else {
                location.reload();
            }
            } else {
                alert('Error updating image: ' + (data.error || ''));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    });
    {% endif %}

    document.addEventListener('click', function(e) {
        if (!e.target.closest('#commentEmojiDropdownContainer')) {
            commentEmojiDropdown.hide();
        }
        if (!e.target.closest('#editCommentEmojiDropdownContainer')) {
            bootstrap.Dropdown.getInstance(document.getElementById('editCommentEmojiDropdownBtn'))?.hide();
        }
    });
});
</script>
{% endblock %}