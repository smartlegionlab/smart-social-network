<script>
$(document).ready(function() {

const commentContent = $('#commentContent');
const commentSubmitBtn = $('#comment-form button[type="submit"]');
const editCommentContent = $('#edit-comment-content');
const editCommentSubmitBtn = $('#edit-comment-form button[type="submit"]');

function checkCommentContent() {
    const content = commentContent.val().trim();
    commentSubmitBtn.prop('disabled', content === '');
}

function checkEditCommentContent() {
    const content = editCommentContent.val().trim();
    editCommentSubmitBtn.prop('disabled', content === '');
}

checkCommentContent();

commentContent.on('input', checkCommentContent);
editCommentContent.on('input', checkEditCommentContent);

const commentEmojiDropdown = new bootstrap.Dropdown(document.getElementById('commentEmojiDropdownBtn'));
const commentEmojiMenu = document.getElementById('commentEmojiDropdownMenu');

$('.comment-emoji-btn').click(function() {
    const emoji = $(this).data('emoji');
    const textarea = $('#commentContent');
    const startPos = textarea[0].selectionStart;
    const endPos = textarea[0].selectionEnd;
    const currentText = textarea.val();

    textarea.val(currentText.substring(0, startPos) + emoji + currentText.substring(endPos));
    textarea.focus();
    textarea[0].setSelectionRange(startPos + emoji.length, startPos + emoji.length);
    checkCommentContent();
});


$(document).on('click', '.edit-comment-emoji-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    const emoji = $(this).data('emoji');
    const textarea = $('#edit-comment-content');
    const startPos = textarea[0].selectionStart;
    const endPos = textarea[0].selectionEnd;
    const currentText = textarea.val();

    textarea.val(currentText.substring(0, startPos) + emoji + currentText.substring(endPos));
    textarea.focus();
    textarea[0].setSelectionRange(startPos + emoji.length, startPos + emoji.length);
    checkEditCommentContent();
});


commentEmojiMenu.addEventListener('click', function(e) {
    e.stopPropagation();
});

document.addEventListener('click', function(e) {
    if (!e.target.closest('#commentEmojiDropdownContainer')) {
        commentEmojiDropdown.hide();
    }
    if (!e.target.closest('#editCommentEmojiDropdownContainer')) {
        bootstrap.Dropdown.getInstance(document.getElementById('editCommentEmojiDropdownBtn'))?.hide();
    }
});


$('#clear-comment').click(function() {
    $('#commentContent').val('').focus();
    checkCommentContent();
});


$('#comment-form').on('submit', async function(e) {
    e.preventDefault();
    const content = commentContent.val().trim();

    if (!content) {
        showAlert('danger', 'Please enter some text before posting', 3000);
        return;
    }

    try {
        const formData = new URLSearchParams(new FormData(this));
        const response = await fetch($(this).attr('action'), {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        });

        const data = await response.json();

        if (response.status === 429) {
            showAlert('warning',
                `â³ Limit exceeded. Try again in ${data.retry_after} seconds.`,
                5000
            );
            return;
        }

        if (!response.ok) {
            throw new Error(data.errors || data.error || 'Server error');
        }

        if (data.success) {
            $('#commentContent').val('').focus();
            showAlert('success', 'Comment posted successfully!', 2000);
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('danger', 'Error: ' + (data.errors || data.error), 3000);
        }

    } catch (error) {
        console.log('Comment error:', error);
        showAlert('danger', 'Server error. Please try again.', 3000);
    }
});

function showAlert(type, message, duration = 3000) {
    const existingAlerts = document.querySelectorAll('.custom-alert');
    for (let i = 0; i < existingAlerts.length; i++) {
        try {
            if (existingAlerts[i] && existingAlerts[i].parentNode) {
                existingAlerts[i].parentNode.removeChild(existingAlerts[i]);
            }
        } catch (e) {
            console.log('Error removing alert:', e);
        }
    }

    const alertHtml = `
        <div class="custom-alert alert alert-${type} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', alertHtml);

    if (duration > 0) {
        setTimeout(() => {
            const alerts = document.querySelectorAll('.custom-alert');
            if (alerts.length > 0) {
                try {
                    alerts[alerts.length - 1].remove();
                } catch (error) {
                    console.log('Error removing alert:', error);
                }
            }
        }, duration);
    }
}

if (!document.getElementById('alert-styles')) {
    const alertStyles = `
    .custom-alert {
        animation: slideInRight 0.3s ease-out;
        background-color: #000000 !important;
        border: 2px solid #28a745 !important;
        border-radius: 10px !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4) !important;
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .alert-warning {
        background-color: #000000 !important;
        border: 2px solid #ffc107 !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4) !important;
    }

    .alert-success {
        background-color: #000000 !important;
        border: 2px solid #28a745 !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4) !important;
    }

    .alert-danger {
        background-color: #000000 !important;
        border: 2px solid #dc3545 !important;
        color: #0d6efd !important;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4) !important;
    }

    .custom-alert .btn-close {
        filter: invert(1) brightness(2);
    }
    `;

    const style = document.createElement('style');
    style.id = 'alert-styles';
    style.textContent = alertStyles;
    document.head.appendChild(style);
}



$(document).on('click', '.edit-comment', function() {
    const commentId = $(this).data('comment-id');
    const commentContentText = $(`.comment[data-comment-id="${commentId}"] .comment-content`).text();

    $('#edit-comment-id').val(commentId);
    $('#edit-comment-content').val(commentContentText);

    const modal = new bootstrap.Modal(document.getElementById('editCommentModal'));
    modal.show();

    setTimeout(() => {
        $('#edit-comment-content').focus();
        checkEditCommentContent();
    }, 500);
});


$('#edit-comment-form').on('submit', function(e) {
    e.preventDefault();
    const content = editCommentContent.val().trim();

    if (!content) {
        alert('Please enter some text before saving');
        return;
    }

    const commentId = $('#edit-comment-id').val();
    $.ajax({
        url: "{% url 'posts:post_comment_update' 0 %}".replace('0', commentId),
        type: 'POST',
        data: $(this).serialize(),
        success: function() {
            location.reload();
        },
        error: function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.errors || 'Server error'));
        }
    });
});


$(document).on('click', '.delete-comment', function() {
if (!confirm('Are you sure you want to delete this comment?')) return;

const commentId = $(this).data('comment-id');

$.ajax({
    url: "{% url 'posts:post_comment_delete' 0 %}".replace('0', commentId),
    method: 'POST',
    headers: {
        'X-CSRFToken': '{{ csrf_token }}'
    },
    success: function(response) {
        if (response.success) {
            location.reload();
        } else {
            alert(response.error || 'Error deleting comment');
        }
    },
    error: function(xhr) {
        if (xhr.status === 403) {
            alert('You do not have permission to delete this comment');
        } else if (xhr.status === 404) {
            alert('Comment not found');
        } else {
            alert('Server error');
        }
    }
});
});

$('.btn-like').click(async function(e) {
    e.preventDefault();
    e.stopPropagation();

    const btn = $(this);
    const icon = btn.find('.like-icon');
    const commentId = btn.data('comment-id');
    const likeCount = $(`#like-count-${commentId}`);

    icon.css('animation', 'none');
    void icon[0].offsetWidth;
    icon.addClass('heart-beat');
    icon.css('animation', 'heartBeat 0.6s cubic-bezier(0.4, 0, 0.2, 1)');

    try {
        const response = await fetch("{% url 'posts:post_comment_like_toggle' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'comment_id': commentId,
            })
        });

        const data = await response.json();

        if (data.limit_reached) {
            showAlert('warning', data.error, 3000);
            return;
        }

        if (data.success) {
            btn.toggleClass('liked');
            btn.attr('title', data.liked ? 'Unlike' : 'Like');
            icon.toggleClass('bi-heart bi-heart-fill');
            likeCount.text(data.likes_count);
        } else {
            showAlert('danger', data.error || 'Error processing like', 3000);
        }

    } catch (error) {
        console.log('Like error:', error);
        showAlert('danger', 'Network error. Please try again.', 3000);
    }
});

});
</script>